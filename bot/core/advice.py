"""
–°–∏—Å—Ç–µ–º–∞ —Å–æ–≤–µ—Ç–æ–≤ –¥–Ω—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
"""
from datetime import datetime, date, timedelta
from typing import List, Dict, Optional
from zoneinfo import ZoneInfo

from bot.core.models import UserState, AdviceState


# –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–æ–≤–µ—Ç–æ–≤
ADVICE_CATEGORIES = {
    "sleep": [
        "–°—Ç–∞—Ä–∞–π—Å—è –ª–æ–∂–∏—Ç—å—Å—è —Å–ø–∞—Ç—å –≤ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –≤—Ä–µ–º—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî —ç—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —á–∞—Å—ã.",
        "–ó–∞ —á–∞—Å –¥–æ —Å–Ω–∞ –æ—Ç–ª–æ–∂–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –¥—Ä—É–≥–∏–µ —ç–∫—Ä–∞–Ω—ã. –°–∏–Ω–∏–π —Å–≤–µ—Ç –º–µ—à–∞–µ—Ç –≤—ã—Ä–∞–±–æ—Ç–∫–µ –º–µ–ª–∞—Ç–æ–Ω–∏–Ω–∞.",
        "–°–æ–∑–¥–∞–π —Ä–∏—Ç—É–∞–ª –ø–µ—Ä–µ–¥ —Å–Ω–æ–º: —á—Ç–µ–Ω–∏–µ, –º–µ–¥–∏—Ç–∞—Ü–∏—è –∏–ª–∏ —Ç—ë–ø–ª–∞—è –≤–∞–Ω–Ω–∞ –ø–æ–º–æ–≥—É—Ç —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è.",
        "–û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤ —Å–ø–∞–ª—å–Ω–µ ‚Äî 18-20¬∞C. –ü—Ä–æ—Ö–ª–∞–¥–Ω—ã–π –≤–æ–∑–¥—É—Ö —Å–ø–æ—Å–æ–±—Å—Ç–≤—É–µ—Ç –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–º—É —Å–Ω—É.",
        "–ò–∑–±–µ–≥–∞–π –∫–æ—Ñ–µ–∏–Ω–∞ –∏ —Ç—è–∂—ë–ª–æ–π –µ–¥—ã –∑–∞ 3-4 —á–∞—Å–∞ –¥–æ —Å–Ω–∞.",
        "–†–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —É–ª—É—á—à–∞—é—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∞, –Ω–æ –Ω–µ –∑–∞–Ω–∏–º–∞–π—Å—è —Å–ø–æ—Ä—Ç–æ–º –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º.",
        "–ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –∑–∞—Å–Ω—É—Ç—å 20 –º–∏–Ω—É—Ç, –≤—Å—Ç–∞–Ω—å –∏ –∑–∞–π–º–∏—Å—å —á–µ–º-—Ç–æ —Å–ø–æ–∫–æ–π–Ω—ã–º, –∑–∞—Ç–µ–º –≤–µ—Ä–Ω–∏—Å—å –≤ –∫—Ä–æ–≤–∞—Ç—å.",
    ],
    "water": [
        "–ù–∞—á–Ω–∏ –¥–µ–Ω—å —Å–æ —Å—Ç–∞–∫–∞–Ω–∞ –≤–æ–¥—ã ‚Äî —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∏ –≤–æ—Å–ø–æ–ª–Ω–∏—Ç—å –ø–æ—Ç–µ—Ä—é –∂–∏–¥–∫–æ—Å—Ç–∏ –∑–∞ –Ω–æ—á—å.",
        "–î–µ—Ä–∂–∏ –±—É—Ç—ã–ª–∫—É —Å –≤–æ–¥–æ–π –≤—Å–µ–≥–¥–∞ –Ω–∞ –≤–∏–¥—É ‚Äî —ç—Ç–æ –Ω–∞–ø–æ–º–Ω–∏—Ç —Ç–µ–±–µ –ø–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω–æ.",
        "–í—ã–ø–∏–≤–∞–π —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –ø—Ä–∏—ë–º–æ–º –ø–∏—â–∏ ‚Äî —ç—Ç–æ —É–ª—É—á—à–∏—Ç –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ.",
        "–ï—Å–ª–∏ —á—É–≤—Å—Ç–≤—É–µ—à—å —É—Å—Ç–∞–ª–æ—Å—Ç—å, –≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –æ–±–µ–∑–≤–æ–∂–∏–≤–∞–Ω–∏–µ. –í—ã–ø–µ–π –≤–æ–¥—ã!",
        "–í –∂–∞—Ä–∫—É—é –ø–æ–≥–æ–¥—É –∏–ª–∏ –ø—Ä–∏ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —É–≤–µ–ª–∏—á—å –Ω–æ—Ä–º—É –≤–æ–¥—ã.",
        "–ù–µ –∂–¥–∏ —á—É–≤—Å—Ç–≤–∞ –∂–∞–∂–¥—ã ‚Äî –∫ —ç—Ç–æ–º—É –º–æ–º–µ–Ω—Ç—É –æ—Ä–≥–∞–Ω–∏–∑–º —É–∂–µ –æ–±–µ–∑–≤–æ–∂–µ–Ω.",
        "–ß–∞–π –∏ –∫–æ—Ñ–µ —Å—á–∏—Ç–∞—é—Ç—Å—è, –Ω–æ —á–∏—Å—Ç–∞—è –≤–æ–¥–∞ ‚Äî –ª—É—á—à–∏–π –≤—ã–±–æ—Ä –¥–ª—è –≥–∏–¥—Ä–∞—Ç–∞—Ü–∏–∏.",
    ],
    "health": [
        "–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø—Ä–æ–≥—É–ª–∫–∏ –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ —É–ª—É—á—à–∞—é—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –∑–¥–æ—Ä–æ–≤—å–µ.",
        "–î–µ–ª–∞–π –ø–µ—Ä–µ—Ä—ã–≤—ã –∫–∞–∂–¥—ã–µ 30-40 –º–∏–Ω—É—Ç –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ –∑–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–º ‚Äî —ç—Ç–æ —Å–Ω–∏–∑–∏—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –≥–ª–∞–∑–∞.",
        "–î—ã—à–∏ –≥–ª—É–±–æ–∫–æ –∏ –º–µ–¥–ª–µ–Ω–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –¥–µ–Ω—å ‚Äî —ç—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç —Å—Ç—Ä–µ—Å—Å.",
        "–ï—à—å –±–æ–ª—å—à–µ –æ–≤–æ—â–µ–π –∏ —Ñ—Ä—É–∫—Ç–æ–≤ ‚Äî –æ–Ω–∏ –±–æ–≥–∞—Ç—ã –≤–∏—Ç–∞–º–∏–Ω–∞–º–∏ –∏ –∫–ª–µ—Ç—á–∞—Ç–∫–æ–π.",
        "–ü—Ä–æ–≤–µ—Ä—è–π –æ—Å–∞–Ω–∫—É: —Å–ø–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä—è–º–æ–π, –ø–ª–µ—á–∏ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω—ã.",
        "–ü–µ–π –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–æ–¥—ã –∏ –µ—à—å —Ä–µ–≥—É–ª—è—Ä–Ω–æ ‚Äî —ç—Ç–æ –æ—Å–Ω–æ–≤–∞ —Ö–æ—Ä–æ—à–µ–≥–æ —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏—è.",
        "–í—ã–¥–µ–ª—è–π –≤—Ä–µ–º—è –¥–ª—è –æ—Ç–¥—ã—Ö–∞ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è ‚Äî —ç—Ç–æ –Ω–µ –ª–µ–Ω—å, –∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å.",
    ],
    "activity": [
        "–î–∞–∂–µ 10 –º–∏–Ω—É—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –¥–µ–Ω—å –ª—É—á—à–µ, —á–µ–º –Ω–∏—á–µ–≥–æ.",
        "–•–æ–¥–∏ –ø–æ –ª–µ—Å—Ç–Ω–∏—Ü–µ –≤–º–µ—Å—Ç–æ –ª–∏—Ñ—Ç–∞ ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –¥–æ–±–∞–≤–∏—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è.",
        "–†–∞—Å—Ç—è–∂–∫–∞ —É—Ç—Ä–æ–º –ø–æ–º–æ–∂–µ—Ç —Ä–∞–∑–±—É–¥–∏—Ç—å —Ç–µ–ª–æ –∏ —É–ª—É—á—à–∏—Ç—å –≥–∏–±–∫–æ—Å—Ç—å.",
        "–¢–∞–Ω—Ü—ã –ø–æ–¥ –ª—é–±–∏–º—É—é –º—É–∑—ã–∫—É ‚Äî —ç—Ç–æ –≤–µ—Å–µ–ª–æ –∏ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –∑–¥–æ—Ä–æ–≤—å—è.",
        "–ü—Ä–æ–≥—É–ª–∫–∞ –ø–æ—Å–ª–µ –µ–¥—ã —É–ª—É—á—à–∞–µ—Ç –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ –∏ –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.",
        "–ù–∞–π–¥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –∫–æ—Ç–æ—Ä–∞—è —Ç–µ–±–µ –Ω—Ä–∞–≤–∏—Ç—Å—è ‚Äî —Ç–∞–∫ –ª–µ–≥—á–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å.",
        "–ó–∞–Ω–∏–º–∞–π—Å—è —Å–ø–æ—Ä—Ç–æ–º —Å –¥—Ä—É–∑—å—è–º–∏ ‚Äî —ç—Ç–æ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –∏ –¥–µ–ª–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ.",
    ],
}


def get_advice_for_today(user: UserState) -> Optional[str]:
    """
    –ü–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None, –µ—Å–ª–∏ —Å–æ–≤–µ—Ç —É–∂–µ –±—ã–ª –ø–æ–ª—É—á–µ–Ω —Å–µ–≥–æ–¥–Ω—è.
    """
    from datetime import datetime, timezone
    
    try:
        tz = ZoneInfo(user.settings.timezone)
    except Exception:
        tz = ZoneInfo("Asia/Vladivostok")
    
    today = date.today().isoformat()
    advice_state = user.advice_state
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–ª—É—á–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≤–µ—Ç —Å–µ–≥–æ–¥–Ω—è
    if advice_state.last_advice_date == today:
        return None
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞—á–∞–ª–æ –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
    today_date = date.today()
    days_since_monday = today_date.weekday()
    week_start = today_date - timedelta(days=days_since_monday)
    week_start_str = week_start.isoformat()
    
    # –ï—Å–ª–∏ –Ω–∞—á–∞–ª–∞—Å—å –Ω–æ–≤–∞—è –Ω–µ–¥–µ–ª—è, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤
    if advice_state.week_start_date != week_start_str:
        advice_state.shown_advice_ids = []
        advice_state.week_start_date = week_start_str
    
    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
    all_advices: List[tuple[str, str]] = []  # (category, advice)
    for category, advices in ADVICE_CATEGORIES.items():
        for i, advice in enumerate(advices):
            advice_id = f"{category}_{i}"
            if advice_id not in advice_state.shown_advice_ids:
                all_advices.append((category, advice))
    
    # –ï—Å–ª–∏ –≤—Å–µ —Å–æ–≤–µ—Ç—ã –ø–æ–∫–∞–∑–∞–Ω—ã, –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ
    if not all_advices:
        advice_state.shown_advice_ids = []
        for category, advices in ADVICE_CATEGORIES.items():
            for i, advice in enumerate(advices):
                advice_id = f"{category}_{i}"
                all_advices.append((category, advice))
    
    # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Å–æ–≤–µ—Ç –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
    import random
    if all_advices:
        category, advice_text = random.choice(all_advices)
        # –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Å–æ–≤–µ—Ç–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        advice_index = ADVICE_CATEGORIES[category].index(advice_text)
        advice_id = f"{category}_{advice_index}"
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º, —á—Ç–æ —ç—Ç–æ—Ç —Å–æ–≤–µ—Ç –±—ã–ª –ø–æ–∫–∞–∑–∞–Ω
        advice_state.shown_advice_ids.append(advice_id)
        advice_state.last_advice_date = today
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–µ—Å—è—á–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        if category not in advice_state.monthly_advice_summary:
            advice_state.monthly_advice_summary[category] = []
        if advice_text not in advice_state.monthly_advice_summary[category]:
            advice_state.monthly_advice_summary[category].append(advice_text)
        
        return advice_text
    
    return None


def get_weekly_advice_summary(user: UserState) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–¥–∫—É –≤—Å–µ—Ö —Å–æ–≤–µ—Ç–æ–≤ –∑–∞ –Ω–µ–¥–µ–ª—é"""
    advice_state = user.advice_state
    
    if not advice_state.shown_advice_ids:
        return "–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ —Ç—ã –µ—â—ë –Ω–µ –ø–æ–ª—É—á–∞–ª —Å–æ–≤–µ—Ç—ã."
    
    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
    shown_advices = []
    for advice_id in advice_state.shown_advice_ids:
        category, index_str = advice_id.split("_", 1)
        index = int(index_str)
        if category in ADVICE_CATEGORIES and index < len(ADVICE_CATEGORIES[category]):
            shown_advices.append(ADVICE_CATEGORIES[category][index])
    
    if not shown_advices:
        return "–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ —Ç—ã –µ—â—ë –Ω–µ –ø–æ–ª—É—á–∞–ª —Å–æ–≤–µ—Ç—ã."
    
    return "\n\n".join([f"‚Ä¢ {advice}" for advice in shown_advices])


def get_monthly_advice_summary(user: UserState) -> str:
    """–ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–¥–∫—É —Å–æ–≤–µ—Ç–æ–≤ –∑–∞ –º–µ—Å—è—Ü –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º"""
    advice_state = user.advice_state
    
    if not advice_state.monthly_advice_summary:
        return "–ó–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü —Ç—ã –µ—â—ë –Ω–µ –ø–æ–ª—É—á–∞–ª —Å–æ–≤–µ—Ç—ã."
    
    category_names = {
        "sleep": "üí§ –°–æ–Ω",
        "water": "üíß –í–æ–¥–∞",
        "health": "üè• –ó–¥–æ—Ä–æ–≤—å–µ",
        "activity": "üèÉ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
    }
    
    lines = []
    for category, advices in advice_state.monthly_advice_summary.items():
        if advices:
            category_name = category_names.get(category, category)
            lines.append(f"\n{category_name}:")
            for advice in advices:
                lines.append(f"  ‚Ä¢ {advice}")
    
    return "\n".join(lines) if lines else "–ó–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü —Ç—ã –µ—â—ë –Ω–µ –ø–æ–ª—É—á–∞–ª —Å–æ–≤–µ—Ç—ã."
