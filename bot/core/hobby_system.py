"""
–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ö–æ–±–±–∏ —Å —Å–µ—Å—Å–∏—è–º–∏, —É—Ä–æ–≤–Ω—è–º–∏ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞ –∏ —Å–ª—É—á–∞–π–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏
"""
import random
from datetime import datetime, timezone
from typing import Tuple, List

from bot.core.models import Hobby, HobbySession, HobbyMastery, PetState


# –°–ª—É—á–∞–π–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –≤–æ –≤—Ä–µ–º—è —Ö–æ–±–±–∏
HOBBY_EVENTS = {
    "sport": [
        ("positive", "üèÜ", "–í—ã–¥—Ä–∞ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∞ –ª–∏—á–Ω—ã–π —Ä–µ–∫–æ—Ä–¥! +15 —Å—á–∞—Å—Ç—å—è", 15),
        ("positive", "ü§ù", "–í—ã–¥—Ä–∞ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∞ –¥—Ä—É–≥–∞ –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ! +10 —Å—á–∞—Å—Ç—å—è", 10),
        ("positive", "üí™", "–í—ã–¥—Ä–∞ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞ –ø—Ä–∏–ª–∏–≤ —Å–∏–ª! +200 –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è", 0),  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
        ("positive", "ü•á", "–í—ã–¥—Ä–∞ –≤—ã–∏–≥—Ä–∞–ª–∞ –≤ —Å–ø–æ—Ä—Ç–∏–≤–Ω–æ–º –ø–æ–µ–¥–∏–Ω–∫–µ! +20 —Å—á–∞—Å—Ç—å—è", 20),
        ("positive", "‚≠ê", "–í—ã–¥—Ä–∞ –ø–æ–∫–∞–∑–∞–ª–∞ –æ—Ç–ª–∏—á–Ω—É—é —Ñ–æ—Ä–º—É! +1 –∫ —É—Ä–æ–≤–Ω—é –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞", 5),
        ("neutral", "üí¶", "–í—ã–¥—Ä–∞ –≤—Å–ø–æ—Ç–µ–ª–∞, –Ω–æ —ç—Ç–æ –Ω–µ –ø–æ–º–µ—à–∞–ª–æ! +5 —Å—á–∞—Å—Ç—å—è", 5),
        ("neutral", "üòÖ", "–í—ã–¥—Ä–∞ –Ω–µ–º–Ω–æ–≥–æ —É—Å—Ç–∞–ª–∞ —Ä–∞–Ω—å—à–µ –≤—Ä–µ–º–µ–Ω–∏, –Ω–æ —Å–ø—Ä–∞–≤–∏–ª–∞—Å—å", 0),
        ("negative", "ü§ï", "–í—ã–¥—Ä–∞ –ø–æ—Ç—è–Ω—É–ª–∞ –º—ã—à—Ü—É, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∞ –∑–∞–Ω–∏–º–∞—Ç—å—Å—è. -5 —ç–Ω–µ—Ä–≥–∏–∏", -5),
        ("negative", "üò´", "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –±—ã–ª–∞ —Ç—è–∂–µ–ª–æ–π —Å–µ–≥–æ–¥–Ω—è. -10 —Å—á–∞—Å—Ç—å—è, –Ω–æ –∑–∞—Ç–æ +300 –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è", -10),
        ("negative", "üåßÔ∏è", "–ü–æ—à–µ–ª –¥–æ–∂–¥—å, –Ω–æ –≤—ã–¥—Ä–∞ –Ω–µ —Å–¥–∞–ª–∞—Å—å! -3 —ç–Ω–µ—Ä–≥–∏–∏, +5 —Å—á–∞—Å—Ç—å—è –∑–∞ —É–ø–æ—Ä—Å—Ç–≤–æ", 5),
    ],
    "creative": [
        ("positive", "üé®", "–í—ã–¥—Ä–∞ —Å–æ–∑–¥–∞–ª–∞ —à–µ–¥–µ–≤—Ä! +25 —Å—á–∞—Å—Ç—å—è", 25),
        ("positive", "‚ú®", "–í—ã–¥—Ä–∞ –≤–¥–æ—Ö–Ω–æ–≤–∏–ª–∞—Å—å! +15 —Å—á–∞—Å—Ç—å—è, +200 –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è", 15),
        ("positive", "üåü", "–ö–æ–ª–ª–µ–≥–∏ –ø–æ—Ö–≤–∞–ª–∏–ª–∏ —Ä–∞–±–æ—Ç—É –≤—ã–¥—Ä—ã! +20 —Å—á–∞—Å—Ç—å—è", 20),
        ("positive", "üé≠", "–í—ã–¥—Ä–∞ –ø–æ–∫–∞–∑–∞–ª–∞ –±–æ–ª—å—à–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å! +1 –∫ —É—Ä–æ–≤–Ω—é –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞", 10),
        ("positive", "üñºÔ∏è", "–í—ã–¥—Ä–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞ –ø—Ä–æ–µ–∫—Ç –±—ã—Å—Ç—Ä–µ–µ –æ–±—ã—á–Ω–æ–≥–æ! +10 —Å—á–∞—Å—Ç—å—è", 10),
        ("neutral", "üí≠", "–í—ã–¥—Ä–∞ —Ä–∞–∑–º—ã—à–ª—è–ª–∞ –æ —Å–º—ã—Å–ª–µ –∏—Å–∫—É—Å—Å—Ç–≤–∞. +5 —Å—á–∞—Å—Ç—å—è", 5),
        ("neutral", "üé™", "–í—ã–¥—Ä–∞ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–ª–∞ —Å –Ω–æ–≤–æ–π —Ç–µ—Ö–Ω–∏–∫–æ–π. –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ!", 5),
        ("negative", "üò§", "–í—ã–¥—Ä–∞ —Å–¥–µ–ª–∞–ª–∞ –æ—à–∏–±–∫—É, –ø—Ä–∏—à–ª–æ—Å—å –ø–µ—Ä–µ–¥–µ–ª—ã–≤–∞—Ç—å. -10 —Å—á–∞—Å—Ç—å—è", -10),
        ("negative", "üî•", "–ö—Ä–∞—Å–∫–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ —Ä–∞–±–æ—Ç—ã! -5 —Å—á–∞—Å—Ç—å—è", -5),
        ("negative", "üò©", "–¢–≤–æ—Ä—á–µ—Å–∫–∏–π –∫—Ä–∏–∑–∏—Å... -15 —Å—á–∞—Å—Ç—å—è, –Ω–æ —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ", -15),
    ],
    "entertainment": [
        ("positive", "üòÇ", "–í—ã–¥—Ä–∞ —Å–º–µ—è–ª–∞—Å—å –Ω–∞ –ø—Ä–æ—Ç—è–∂–µ–Ω–∏–∏ –≤—Å–µ–≥–æ —à–æ—É! +20 —Å—á–∞—Å—Ç—å—è", 20),
        ("positive", "üé¨", "–§–∏–ª—å–º/—Å–ø–µ–∫—Ç–∞–∫–ª—å –±—ã–ª –ø–æ—Ç—Ä—è—Å–∞—é—â–∏–º! +25 —Å—á–∞—Å—Ç—å—è", 25),
        ("positive", "üéµ", "–ú—É–∑—ã–∫–∞ —Ä–∞—Å—Ç—Ä–æ–≥–∞–ª–∞ –≤—ã–¥—Ä—É –¥–æ —Å–ª—ë–∑ (–≤ —Ö–æ—Ä–æ—à–µ–º —Å–º—ã—Å–ª–µ)! +20 —Å—á–∞—Å—Ç—å—è", 20),
        ("positive", "ü§©", "–í—ã–¥—Ä–∞ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∞ —Å–≤–æ–µ–≥–æ –ª—é–±–∏–º–æ–≥–æ –∞—Ä—Ç–∏—Å—Ç–∞! +30 —Å—á–∞—Å—Ç—å—è", 30),
        ("positive", "üåà", "–í—ã–¥—Ä–∞ –ø—Ä–∏–æ–±—Ä–µ–ª–∞ –Ω–æ–≤—ã–π –≤–∑–≥–ª—è–¥ –Ω–∞ –∂–∏–∑–Ω—å! +15 —Å—á–∞—Å—Ç—å—è", 15),
        ("neutral", "üçø", "–í—ã–¥—Ä–∞ –Ω–∞—Å–ª–∞–∂–¥–∞–ª–∞—Å—å –ø–æ–ø–∫–æ—Ä–Ω–æ–º. +8 —Å—á–∞—Å—Ç—å—è", 8),
        ("neutral", "üì±", "–í—ã–¥—Ä–∞ –¥–µ–ª–∞–ª–∞ —Ñ–æ—Ç–æ –≤ –º—É–∑–µ–µ. –í–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è! +5 —Å—á–∞—Å—Ç—å—è", 5),
        ("negative", "üòí", "–ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –±—ã–ª–æ —Å–∫—É—á–Ω—ã–º. -10 —Å—á–∞—Å—Ç—å—è", -10),
        ("negative", "üò°", "–†—è–¥–æ–º —Å–∏–¥–µ–ª–∞ —à—É–º–Ω–∞—è –≤—ã–¥—Ä–∞! -8 —Å—á–∞—Å—Ç—å—è", -8),
        ("negative", "üò¥", "–í—ã–¥—Ä–∞ –ø–æ—á—Ç–∏ —É—Å–Ω—É–ª–∞ –Ω–∞ –∫–æ–Ω—Ü–µ—Ä—Ç–µ. -5 —Å—á–∞—Å—Ç—å—è, –Ω–æ –æ—Ç–¥–æ—Ö–Ω—É–ª–∞", -5),
    ],
    "walk": [
        ("positive", "üå∏", "–í—ã–¥—Ä–∞ –Ω–∞—à–ª–∞ –∫—Ä–∞—Å–∏–≤—ã–π —Ü–≤–µ—Ç–æ–∫! +12 —Å—á–∞—Å—Ç—å—è", 12),
        ("positive", "üêøÔ∏è", "–í—ã–¥—Ä–∞ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∞ –±–µ–ª–∫—É –∏ –æ–Ω–∏ –ø–æ–¥—Ä—É–∂–∏–ª–∏—Å—å! +15 —Å—á–∞—Å—Ç—å—è", 15),
        ("positive", "‚òÄÔ∏è", "–û—Ç–ª–∏—á–Ω–∞—è –ø–æ–≥–æ–¥–∞! –í—ã–¥—Ä–∞ —Å–≤–µ—Ç–∏–ª–∞—Å—å –æ—Ç —Å—á–∞—Å—Ç—å—è. +10 —Å—á–∞—Å—Ç—å—è", 10),
        ("positive", "ü¶Ü", "–í—ã–¥—Ä–∞ –∫–æ—Ä–º–∏–ª–∞ —É—Ç–æ–∫ –≤ –ø—Ä—É–¥—É! +8 —Å—á–∞—Å—Ç—å—è", 8),
        ("positive", "üèûÔ∏è", "–í—ã–¥—Ä–∞ –Ω–∞—à–ª–∞ –ø–æ—Ç—Ä—è—Å–∞—é—â–µ–µ –º–µ—Å—Ç–æ –¥–ª—è –æ—Ç–¥—ã—Ö–∞! +200 –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è", 0),
        ("neutral", "üßò", "–í—ã–¥—Ä–∞ –º–µ–¥–∏—Ç–∏—Ä–æ–≤–∞–ª–∞ –Ω–∞ —Å–∫–∞–º–µ–π–∫–µ. +5 —Å—á–∞—Å—Ç—å—è, +100 –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è", 5),
        ("neutral", "üì∏", "–í—ã–¥—Ä–∞ —Å–¥–µ–ª–∞–ª–∞ –∫—Ä–∞—Å–∏–≤—ã–µ —Ñ–æ—Ç–æ –ø—Ä–∏—Ä–æ–¥—ã! +5 —Å—á–∞—Å—Ç—å—è", 5),
        ("negative", "üåßÔ∏è", "–ü–æ—à—ë–ª –¥–æ–∂–¥—å, –Ω–æ –≤—ã–¥—Ä–∞ –≥—É–ª—è–ª –≤ –ª—é–±—É—é –ø–æ–≥–æ–¥—É. -3 —Å—á–∞—Å—Ç—å—è, +100 –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è", -3),
        ("negative", "üò©", "–í—ã–¥—Ä–∞ –æ—á–µ–Ω—å —É—Å—Ç–∞–ª–∞, –Ω–æ –ø—Ä–æ–≥—É–ª–∫–∞ –ø–æ–º–æ–≥–ª–∞. +5 —Å—á–∞—Å—Ç—å—è", 5),
        ("negative", "üêù", "–í—ã–¥—Ä–∞ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∞ –∑–ª—É—é –ø—á–µ–ª—É! -5 —Å—á–∞—Å—Ç—å—è, -2 —ç–Ω–µ—Ä–≥–∏–∏", -5),
    ],
}

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Ö–æ–±–±–∏
GLOBAL_EVENTS = [
    ("positive", "üí´", "–í—ã–¥—Ä–∞ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞ —Å–µ–±—è —Å—á–∞—Å—Ç–ª–∏–≤–æ–π! +10 —Å—á–∞—Å—Ç—å—è", 10),
    ("positive", "üéâ", "–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –±–æ–Ω—É—Å —Å—á–∞—Å—Ç—å—è! +20 —Å—á–∞—Å—Ç—å—è", 20),
    ("positive", "üçÄ", "–í–µ–∑—É—Ö–∞ –≤—ã–¥—Ä—ã! +15 —Å—á–∞—Å—Ç—å—è", 15),
    ("neutral", "ü§î", "–í—ã–¥—Ä–∞ –∑–∞–¥—É–º–∞–ª–∞—Å—å –æ —á—ë–º-—Ç–æ. +0 —Å—á–∞—Å—Ç—å—è, –Ω–æ –º–Ω–æ–≥–æ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π", 0),
    ("negative", "üòï", "–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –Ω–æ –Ω–∏—á–µ–≥–æ —Å—Ç—Ä–∞—à–Ω–æ–≥–æ. -5 —Å—á–∞—Å—Ç—å—è", -5),
]


def get_hobby_effectiveness(hobby: Hobby) -> Tuple[int, int, int]:
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ö–æ–±–±–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ —Ü–µ–Ω—ã.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (—Å—á–∞—Å—Ç—å–µ, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ_—É—Å—Ç–∞–ª–æ—Å—Ç–∏, —É—Ä–æ–Ω_—ç–Ω–µ—Ä–≥–∏–∏)
    
    –§–æ—Ä–º—É–ª–∞: —á–µ–º –¥–æ—Ä–æ–∂–µ —Ö–æ–±–±–∏, —Ç–µ–º –±–æ–ª—å—à–µ —ç—Ñ—Ñ–µ–∫—Ç
    - –¶–µ–Ω–∞ 20: –±–∞–∑–æ–≤—ã–π —ç—Ñ—Ñ–µ–∫—Ç
    - –¶–µ–Ω–∞ 50: –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –≤ —Ç–µ–∫—É—â–µ–º –Ω–∞–±–æ—Ä–µ
    """
    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ü–µ–Ω—É (–æ—Ç 20 –¥–æ 50)
    normalized_price = min(50, max(20, hobby.price))
    
    # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ—Ç 1.0 (–ø—Ä–∏ —Ü–µ–Ω–µ 20) –¥–æ 2.5 (–ø—Ä–∏ —Ü–µ–Ω–µ 50)
    price_multiplier = 1.0 + (normalized_price - 20) / 12.0
    
    # –ë–∞–∑–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤
    if hobby.hobby_type == "sport":
        base_happiness = 12
        base_recovery = 150
        base_energy_cost = 10
    elif hobby.hobby_type == "creative":
        base_happiness = 10
        base_recovery = 100
        base_energy_cost = 7
    elif hobby.hobby_type == "entertainment":
        base_happiness = 11
        base_recovery = 80
        base_energy_cost = 5
    else:  # walk
        base_happiness = 8
        base_recovery = 100
        base_energy_cost = 3
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å —Ü–µ–Ω—ã
    happiness = int(base_happiness * price_multiplier)
    recovery = int(base_recovery * price_multiplier)
    energy_cost = int(base_energy_cost * (0.8 + 0.4 * (price_multiplier - 1.0)))  # –≠–Ω–µ—Ä–≥–∏—è —Ä–∞—Å—Ç—ë—Ç –º–µ–¥–ª–µ–Ω–Ω–µ–µ
    
    return happiness, recovery, energy_cost


def get_duration_for_hobby(hobby: Hobby) -> int:
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–∏ –≤ –º–∏–Ω—É—Ç–∞—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ –∏ —Ü–µ–Ω—ã.
    –ë–æ–ª–µ–µ –¥–æ—Ä–æ–≥–∏–µ —Ö–æ–±–±–∏ –¥–ª—è—Ç—Å—è –¥–æ–ª—å—à–µ, –¥–∞—é—Ç –±–æ–ª—å—à–µ –æ–ø—ã—Ç–∞.
    """
    base_duration = {
        "sport": 60,
        "creative": 90,
        "entertainment": 75,
        "walk": 45,
    }
    
    normalized_price = min(50, max(20, hobby.price))
    price_multiplier = 1.0 + (normalized_price - 20) / 30.0
    
    return int(base_duration.get(hobby.hobby_type, 60) * price_multiplier)


def calculate_mastery_level(sessions: int) -> int:
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞ (1-5 –∑–≤—ë–∑–¥) –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–µ—Å—Å–∏–π.
    """
    if sessions < 3:
        return 1
    elif sessions < 8:
        return 2
    elif sessions < 16:
        return 3
    elif sessions < 30:
        return 4
    else:
        return 5


def get_mastery_bonus(mastery_level: int) -> Tuple[float, float]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–æ–Ω—É—Å—ã –∑–∞ —É—Ä–æ–≤–µ–Ω—å –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (–º–Ω–æ–∂–∏—Ç–µ–ª—å —Å—á–∞—Å—Ç—å—è, –º–Ω–æ–∂–∏—Ç–µ–ª—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è)
    """
    bonuses = {
        1: (1.0, 1.0),
        2: (1.1, 1.1),
        3: (1.2, 1.25),
        4: (1.35, 1.4),
        5: (1.5, 1.6),
    }
    return bonuses.get(mastery_level, (1.0, 1.0))


def get_random_event(hobby_type: str) -> Tuple[str, str, str, int]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è —Ç–∏–ø–∞ —Ö–æ–±–±–∏.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (—Ç–∏–ø_—Å–æ–±—ã—Ç–∏—è, —ç–º–æ–¥–∑–∏, —Ç–µ–∫—Å—Ç, –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä_—Å—á–∞—Å—Ç—å—è)
    """
    events = HOBBY_EVENTS.get(hobby_type, GLOBAL_EVENTS)
    
    # 80% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å–æ–±—ã—Ç–∏—è –∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞, 20% –∏–∑ –æ–±—â–µ–≥–æ
    if random.random() < 0.8 and events != GLOBAL_EVENTS:
        chosen_events = events
    else:
        chosen_events = GLOBAL_EVENTS
    
    event_type, emoji, text, modifier = random.choice(chosen_events)
    return event_type, emoji, text, modifier


def update_hobby_streak(mastery: HobbyMastery, today: str) -> None:
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç—Ä–∏–∫ –¥–ª—è —Ö–æ–±–±–∏ (–µ—Å–ª–∏ –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –¥–µ–Ω—å –∑–∞ –¥–Ω—ë–º).
    """
    if mastery.last_session_date is None:
        mastery.streak = 1
    elif mastery.last_session_date == today:
        # –£–∂–µ –∑–∞–Ω–∏–º–∞–ª–∏—Å—å —Å–µ–≥–æ–¥–Ω—è, —Å—Ç—Ä–∏–∫ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
        pass
    else:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —ç—Ç–æ –≤—á–µ—Ä–∞
        try:
            from datetime import datetime, timedelta
            last_date = datetime.fromisoformat(mastery.last_session_date).date()
            today_date = datetime.fromisoformat(today).date()
            days_diff = (today_date - last_date).days
            
            if days_diff == 1:
                # –í—á–µ—Ä–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–µ—Å—Å–∏—è, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—Ç—Ä–∏–∫
                mastery.streak += 1
            else:
                # –ü—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ –¥–Ω—è, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç—Ä–∏–∫
                mastery.streak = 1
        except Exception:
            mastery.streak = 1
    
    mastery.last_session_date = today


def get_streak_bonus(streak: int) -> float:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–æ–Ω—É—Å –∑–∞ —Å—Ç—Ä–∏–∫ (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –¥–Ω–∏ –∑–∞–Ω—è—Ç–∏–π).
    """
    if streak < 2:
        return 1.0
    elif streak == 2:
        return 1.05
    elif streak == 3:
        return 1.1
    elif streak == 5:
        return 1.2
    elif streak >= 7:
        return 1.3
    return 1.0


def get_overuse_penalty(streak: int) -> float:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —à—Ç—Ä–∞—Ñ –∑–∞ –ø–µ—Ä–µ—É—Ç–æ–º–ª–µ–Ω–∏–µ –æ—Ç –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ —Ö–æ–±–±–∏.
    –ï—Å–ª–∏ –¥–µ–ª–∞—Ç—å –æ–¥–Ω–æ —Ö–æ–±–±–∏ –±–æ–ª–µ–µ 3 –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥, —ç—Ñ—Ñ–µ–∫—Ç —Å–Ω–∏–∂–∞–µ—Ç—Å—è.
    """
    if streak <= 3:
        return 1.0
    elif streak == 4:
        return 0.9
    elif streak == 5:
        return 0.85
    elif streak == 6:
        return 0.8
    else:  # 7+
        return 0.75


def format_hobby_session_result(
    hobby: Hobby,
    happiness_gained: int,
    fatigue_recovered: int,
    energy_lost: int,
    event_emoji: str,
    event_text: str,
    mastery_level: int,
    streak: int,
) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–µ—Å—Å–∏–∏ —Ö–æ–±–±–∏ –≤ –∫—Ä–∞—Å–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    """
    stars = "‚≠ê" * mastery_level + "‚òÜ" * (5 - mastery_level)
    
    message = (
        f"ü¶¶ –í—ã–¥—Ä–∞ –∑–∞–Ω–∏–º–∞–ª–∞—Å—å: {hobby.title}\n\n"
        f"{event_emoji} {event_text}\n\n"
        f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:\n"
        f"üòä –°—á–∞—Å—Ç—å–µ: +{happiness_gained}\n"
        f"üí™ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: +{fatigue_recovered}\n"
        f"‚ö° –≠–Ω–µ—Ä–≥–∏—è: -{energy_lost}\n\n"
        f"üèÜ –ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ: {stars} (—É—Ä–æ–≤–µ–Ω—å {mastery_level})\n"
    )
    
    if streak > 1:
        message += f"üî• –°—Ç—Ä–∏–∫: {streak} –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥"
        if streak >= 7:
            message += " (–æ—Ç–ª–∏—á–Ω–æ! +20% –∫ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)"
        message += "\n"
    
    message += f"\n–í—Ä–µ–º—è —Å–µ—Å—Å–∏–∏: {get_duration_for_hobby(hobby)} –º–∏–Ω—É—Ç"
    
    return message


def get_hobby_recommendations(pet_state) -> List[Tuple[str, str]]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ö–æ–±–±–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—ã–¥—Ä—ã.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: —Å–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π (—Ç–∏–ø_—Ö–æ–±–±–∏, –æ–ø–∏—Å–∞–Ω–∏–µ_—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)
    """
    recommendations = []
    
    # –ï—Å–ª–∏ —Å—á–∞—Å—Ç—å–µ –Ω–∏–∑–∫–æ–µ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è
    if pet_state.happiness < 30:
        recommendations.append((
            "entertainment",
            "üò¢ –í—ã–¥—Ä–∞ –æ—á–µ–Ω—å –≥—Ä—É—Å—Ç–Ω–∞—è! –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è (–∫–∏–Ω–æ, —Ç–µ–∞—Ç—Ä, –∫–æ–Ω—Ü–µ—Ä—Ç—ã) "
            "‚Äî –æ–Ω–∏ –ø–æ–º–æ–≥—É—Ç –ø–æ–¥–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –¥–∞–¥—É—Ç –º–∞–∫—Å–∏–º—É–º —Å—á–∞—Å—Ç—å—è! üé≠"
        ))
    
    # –ï—Å–ª–∏ —Å—á–∞—Å—Ç—å–µ —Å—Ä–µ–¥–Ω–µ–µ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ
    elif pet_state.happiness < 50:
        recommendations.append((
            "creative",
            "üòî –í—ã–¥—Ä–∞ –≥—Ä—É—Å—Ç–∏—Ç. –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ (—Ä–∏—Å–æ–≤–∞–Ω–∏–µ, –º—É–∑—ã–∫–∞) –ø–æ–º–æ–∂–µ—Ç –µ–π –≤—ã—Ä–∞–∑–∏—Ç—å —Å–µ–±—è "
            "–∏ –ø–æ–¥–Ω—è—Ç—å —Å—á–∞—Å—Ç—å–µ! üé®"
        ))
    
    # –ï—Å–ª–∏ —É—Å—Ç–∞–ª–æ—Å—Ç—å –≤—ã—Å–æ–∫–∞—è, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å–ø–æ—Ä—Ç
    if pet_state.fatigue > 70:
        recommendations.append((
            "sport",
            "üò´ –í—ã–¥—Ä–∞ –æ—á–µ–Ω—å —É—Å—Ç–∞–ª–∞ –æ—Ç —Ä–∞–±–æ—Ç—ã! –°–ø–æ—Ä—Ç –ª—É—á—à–µ –≤—Å–µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç –µ—ë —ç–Ω–µ—Ä–≥–∏—é "
            "–∏ –ø–æ–º–æ–∂–µ—Ç —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å —É—Å—Ç–∞–ª–æ—Å—Ç—å—é! üí™"
        ))
    
    # –ï—Å–ª–∏ —É—Å—Ç–∞–ª–æ—Å—Ç—å —Å—Ä–µ–¥–Ω—è—è, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ –∏–ª–∏ –ø—Ä–æ–≥—É–ª–∫—É
    elif pet_state.fatigue > 50:
        recommendations.append((
            "creative",
            "ü§î –í—ã–¥—Ä–∞ –Ω–µ–º–Ω–æ–≥–æ —É—Å—Ç–∞–ª–∞. –¢–≤–æ—Ä—á–µ—Å–∫–æ–µ —Ö–æ–±–±–∏ –∏–ª–∏ –ø—Ä–æ–≥—É–ª–∫–∞ –ø–æ–º–æ–≥—É—Ç –µ—ë —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è! üé®"
        ))
    
    # –ï—Å–ª–∏ —ç–Ω–µ—Ä–≥–∏—è –Ω–∏–∑–∫–∞—è, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø—Ä–æ–≥—É–ª–∫—É (—Å–∞–º–æ–µ –º—è–≥–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ)
    if pet_state.energy < 20:
        recommendations.append((
            "walk",
            "‚ö° –í—ã–¥—Ä–∞ –ø–æ—á—Ç–∏ –±–µ–∑ —Å–∏–ª! –ü—Ä–æ–≥—É–ª–∫–∞ –ø–æ –ø–∞—Ä–∫—É ‚Äî —ç—Ç–æ –º—è–≥–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, "
            "–∫–æ—Ç–æ—Ä–æ–µ –Ω–µ –ø–æ—Ç—Ä–µ–±—É–µ—Ç –º–Ω–æ–≥–æ —ç–Ω–µ—Ä–≥–∏–∏! üå≥"
        ))
    
    # –ï—Å–ª–∏ —Å—á–∞—Å—Ç—å–µ –∏ —ç–Ω–µ—Ä–≥–∏—è –≤ –Ω–æ—Ä–º–µ, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ª—é–±–æ–µ —Ö–æ–±–±–∏
    if pet_state.happiness >= 50 and pet_state.fatigue <= 50 and pet_state.energy >= 50:
        recommendations.append((
            "any",
            "‚ú® –í—ã–¥—Ä–∞ –≤ –æ—Ç–ª–∏—á–Ω–æ–π —Ñ–æ—Ä–º–µ! –û–Ω–∞ –º–æ–∂–µ—Ç –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ª—é–±–æ–µ —Ö–æ–±–±–∏ –∏–ª–∏ –Ω–æ–≤–æ–µ, "
            "–∫–æ—Ç–æ—Ä–æ–µ –µ—â—ë –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–ª–∞! üåü"
        ))
    
    return recommendations


def get_hobby_stats_summary(pet_state, hobbies_repo) -> str:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—Ä–∞—Ç–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ö–æ–±–±–∏.
    """
    if not pet_state.hobby_mastery:
        return "üé® –£ –≤—ã–¥—Ä—ã –ø–æ–∫–∞ –Ω–µ—Ç –æ–ø—ã—Ç–∞ –Ω–∏ –≤ –æ–¥–Ω–æ–º —Ö–æ–±–±–∏. –ü–æ–ø—Ä–æ–±—É–π –Ω–∞—á–∞—Ç—å —Å —á–µ–≥–æ-–Ω–∏–±—É–¥—å! ü¶¶"
    
    # –ù–∞—Ö–æ–¥–∏–º –ª—é–±–∏–º–æ–µ —Ö–æ–±–±–∏
    favorite_hobby_id = max(
        pet_state.hobby_mastery.keys(),
        key=lambda hid: pet_state.hobby_mastery[hid].total_sessions
    )
    
    favorite_mastery = pet_state.hobby_mastery[favorite_hobby_id]
    hobbies = hobbies_repo.get_all()
    favorite_hobby = hobbies.get(favorite_hobby_id)
    
    stars = "‚≠ê" * favorite_mastery.level + "‚òÜ" * (5 - favorite_mastery.level)
    
    total_sessions = sum(m.total_sessions for m in pet_state.hobby_mastery.values())
    total_hours = sum(
        (get_duration_for_hobby(hobbies.get(hid, hobbies.get("walk"))) / 60.0) * m.total_sessions
        for hid, m in pet_state.hobby_mastery.items()
    )
    
    message = (
        f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ö–æ–±–±–∏:\n\n"
        f"üèÜ –õ—é–±–∏–º–æ–µ —Ö–æ–±–±–∏: {favorite_hobby.title if favorite_hobby else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}\n"
        f"üë• –°–µ—Å—Å–∏–π: {favorite_mastery.total_sessions}\n"
        f"‚≠ê –ú–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ: {stars}\n"
        f"üî• –¢–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–∫: {favorite_mastery.streak} –¥–Ω–µ–π\n\n"
        f"üìà –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n"
        f"üé® –í—Å–µ–≥–æ —Ö–æ–±–±–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: {len(pet_state.unlocked_hobbies)}\n"
        f"‚è±Ô∏è –í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π: {total_sessions}\n"
        f"‚è∞ –í—Å–µ–≥–æ —á–∞—Å–æ–≤: {total_hours:.1f}\n"
    )
    
    return message


# –°–æ–±—ã—Ç–∏—è –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ö–æ–±–±–∏ (—Å–æ–≤–º–µ—Å—Ç–Ω—ã–µ)
SOCIAL_HOBBY_EVENTS = [
    ("positive", "ü§ù", "–í—ã–¥—Ä—ã –æ—Ç–ª–∏—á–Ω–æ –ø–æ–ª–∞–¥–∏–ª–∏! +15 —Å—á–∞—Å—Ç—å—è –æ–±–µ–∏–º", 15),
    ("positive", "üéâ", "–í–µ—Å—ë–ª–∞—è —Å–æ–≤–º–µ—Å—Ç–Ω–∞—è –∏–≥—Ä–∞! +20 —Å—á–∞—Å—Ç—å—è", 20),
    ("positive", "üëØ", "–í—ã–¥—Ä—ã —Å—Ç–∞–ª–∏ –ª—É—á—à–∏–º–∏ –ø–æ–¥—Ä—É–≥–∞–º–∏! +25 —Å—á–∞—Å—Ç—å—è", 25),
    ("positive", "üèÖ", "–°–æ–≤–º–µ—Å—Ç–Ω—ã–π —É—Å–ø–µ—Ö! +30 —Å—á–∞—Å—Ç—å—è", 30),
    ("positive", "üíï", "–í–æ–ª—à–µ–±–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥—Ä—É–∂–±—ã! +35 —Å—á–∞—Å—Ç—å—è", 35),
    ("neutral", "üòä", "–°–ø–æ–∫–æ–π–Ω–æ–µ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–µ –≤—Ä–µ–º—è. +10 —Å—á–∞—Å—Ç—å—è", 10),
    ("neutral", "ü§ó", "–í—ã–¥—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∞–ª–∏ –¥—Ä—É–≥ –¥—Ä—É–≥–∞. +8 —Å—á–∞—Å—Ç—å—è", 8),
    ("negative", "üòï", "–ù–µ —Å–æ–≤—Å–µ–º –ø–æ–ª—É—á–∏–ª–æ—Å—å, –Ω–æ –±—ã–ª–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ. +5 —Å—á–∞—Å—Ç—å—è", 5),
    ("negative", "ü§î", "–í—ã–¥—Ä—ã –ª—É—á—à–µ –∑–Ω–∞—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞. +2 —Å—á–∞—Å—Ç—å—è", 2),
]


def get_social_hobby_event() -> Tuple[str, str, str, int]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ (—Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ) —Ö–æ–±–±–∏.
    """
    event_type, emoji, text, modifier = random.choice(SOCIAL_HOBBY_EVENTS)
    return event_type, emoji, text, modifier


def get_social_bonus(num_participants: int) -> float:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–æ–Ω—É—Å –∑–∞ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–µ —Ö–æ–±–±–∏ (—á–∏—Å–ª–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤).
    
    –ë–æ–ª—å—à–µ –≤—ã–¥—Ä = –±–æ–ª—å—à–µ –≤–µ—Å–µ–ª—å—è –∏ –ø–æ–∑–∏—Ç–∏–≤–∞!
    """
    bonuses = {
        2: 1.2,   # –î–≤–æ–µ ‚Äî +20%
        3: 1.4,   # –¢—Ä–æ–µ ‚Äî +40%
        4: 1.6,   # –ß–µ—Ç–≤–µ—Ä–æ ‚Äî +60%
        5: 1.8,   # –ü—è—Ç–µ—Ä–æ ‚Äî +80%
    }
    return bonuses.get(min(num_participants, 5), 1.0)


def format_social_hobby_result(
    hobby_title: str,
    participants: int,
    happiness_gained: int,
    fatigue_recovered: int,
    event_emoji: str,
    event_text: str,
) -> str:
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ü–∏–∞–ª—å–Ω–æ–≥–æ (—Å–æ–≤–º–µ—Å—Ç–Ω–æ–≥–æ) —Ö–æ–±–±–∏.
    """
    message = (
        f"ü¶¶üë• –°–æ–≤–º–µ—Å—Ç–Ω–æ–µ —Ö–æ–±–±–∏: {hobby_title}\n\n"
        f"üë• –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {participants} –≤—ã–¥—Ä(—ã)\n"
        f"{event_emoji} {event_text}\n\n"
        f"üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –≤—ã–¥—Ä—ã:\n"
        f"üòä –°—á–∞—Å—Ç—å–µ: +{happiness_gained}\n"
        f"üí™ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: +{fatigue_recovered}\n"
        f"üíï –î—Ä—É–∂–±–∞ –∫—Ä–µ–ø–Ω–µ—Ç!\n"
    )
    
    if participants >= 3:
        message += f"\nüéâ –ë–æ–Ω—É—Å –∑–∞ –∫–æ–º–ø–∞–Ω–∏—é: +{int((get_social_bonus(participants) - 1) * 100)}% —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏!"
    
    return message
